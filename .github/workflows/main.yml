name: Smart Release Manager

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: File validation
        run: |
          [ -f ./myproxy.txt ] || { echo "myproxy.txt missing"; exit 1; }
          [ -f ./mydirect.txt ] || { echo "mydirect.txt missing"; exit 1; }

      - name: Delete existing release (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ é™¤ä¸æ ‡ç­¾å…³è”çš„æ—§å‘å¸ƒ
          if gh release view latest &> /dev/null; then
            gh release delete latest -y
            echo "Deleted existing release"
          fi

          # å¼ºåˆ¶æ›´æ–°æ ‡ç­¾
          git tag -f latest
          git push origin latest --force

      - name: Create/Overwrite Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: "Dynamic Release (${GITHUB_SHA:0:7})"
          body: |
            ğŸ“… Build Time: ${{ steps.date.outputs.timestamp }}
            ğŸ“œ Commit: ${{ github.event.head_commit.message }}
          files: |
            myproxy.txt
            mydirect.txt
          replace_existing: true  # å…³é”®è¦†ç›–å‚æ•°
          generate_release_notes: true

      - name: Prune old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–ä¿ç•™çª—å£ï¼ˆä¿ç•™æœ€æ–°3ä¸ªï¼‰
          keep_releases=3

          # è·å–å¾…åˆ é™¤çš„Release IDåˆ—è¡¨
          releases=$(gh api repos/${{ github.repository }}/releases \
            --jq "sort_by(.created_at) | reverse | .[$keep_releases:] | .[].id")

          # æ‰¹é‡åˆ é™¤
          echo "$releases" | while read id; do
            gh api repos/${{ github.repository }}/releases/$id -X DELETE
            echo "ğŸš® Deleted release ID: $id"
          done
